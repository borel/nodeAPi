<html>
    <head>
        <title>Smoozi Tracker</title>
    </head>
    <body>

        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmhelMVEXev83EyFPJhCJ1fYnQleKPfos&sensor=true"></script>
        <script type="text/javascript" src="/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="./jquery.min.js"></script>
        <script type="text/javascript" src="./marathon.js"></script>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-57925881-11', 'auto');
          ga('send', 'pageview');

        </script>

      	<script type="text/javascript">
              ////////////////////////////////////////////////////////////////////
              ////////////// GMAPS ///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////
              var map = null;
              var users = {};

              function guid() {
                function s4() { return Math.floor((1 + Math.random()) * 0x10000)
                    .toString(16).substring(1);
                };

                return s4() + s4() + '-' + s4() + '-' + s4() + s4();
            }


              var userInfo = {
                  id: guid(),
                  name: 'Anonymous'
              }

              function mapInitialize() {
                  map = new google.maps.Map(document.getElementById("map-canvas"), {
                      zoom: 12,
                      // nyc   center: new google.maps.LatLng(40.742494, -73.953867)
                      center: new google.maps.LatLng(45.764043, 4.835659)
                  });
                  infowindow = new google.maps.InfoWindow({ content: 'Test' });
                  google.maps.event.addListener(map, 'click', function() {
                      infowindow.close(map);
                  });

                  nycMarathonInitialize();
              }


              function nycMarathonInitialize(){
                  var nycMarathon = new google.maps.Polyline({
                  path: nycMarathonCoordinates,
                  geodesic: true,
                  strokeColor: '#FF0000',
                  strokeOpacity: 1.0,
                  strokeWeight: 2
                });

                  nycMarathon.setMap(map);
              }


              function updateMarker(name,lat,long){

                // Take the user
                      var userInformation = users[name];

                      // si il n'esite pas on cr√©ait le marker et son user
                        if(!userInformation){
                          // New object of user info
                          users[name] = userInfo;

                          // affect to userInformation for update
                          userInformation = users[name];

                          // crearte the marker
                          var marker = new google.maps.Marker({ map:map });
                           google.maps.event.addListener(marker, 'click', function() {
                                       infowindow.setContent(marker.getTitle());
                                       infowindow.open(map, marker);
                           });

                           // Img management
                           if(name === 'lj'){
                             marker.setIcon('./img/LJ.png')
                           }else{
                             marker.setIcon('./img/ML.png')
                           }

                           //affect the marker
                           userInformation.marker = marker;
                        }

                  //On update le marker ( qu(il soit nouveau ou ancien))
                  userInformation.marker.setPosition(new google.maps.LatLng(lat, long));

              }

              function updateIndicator(name,hr,speed,distance){
                if(name === 'lj'){
                  document.getElementById("lj_hr").textContent = hr;
                  document.getElementById("lj_speed").textContent = speed;
                  document.getElementById("lj_distance").textContent = distance;

                }else{
                  document.getElementById("ml_hr").textContent = hr;
                  document.getElementById("ml_speed").textContent = speed;
                  document.getElementById("ml_distance").textContent = distance;
                }
              }


              ////////////////////////////////////////////////////////////////////
              ////////////// /GMAPS ///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////




              ////////////////////////////////////////////////////////////////////
              ////////////// Socket///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////
              var socket = io.connect('/');

              socket.on('message', function(data) {
                  updateMarker(data.user,data.lat,data.long);
                  updateIndicator(data.user,data.hr,data.speed,data.distance);

              })
              ////////////////////////////////////////////////////////////////////
              ////////////// /Socket///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////

              ////////////////////////////////////////////////////////////////////
              ////////////// Common ///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////
              google.maps.event.addDomListener(window, 'load', mapInitialize);
              ////////////////////////////////////////////////////////////////////
              ////////////// /Common///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////


      	</script>

        <style>
            #map-canvas  { height: 60%; width:100%}
        </style>

        <p> Welcome to NYC marathon tracker</p>
        <div id="map-canvas"></div>
        <table style="width:20% ">
          <tr>
            <td> <b>User</b> </td>
            <td> <b>Heart Rate</b> </td>
            <td> <b>Distance</b> </td>
            <td> <b>Speed</b> </td>
          </tr>
          <tr>
            <td>Landreau</td>
            <td> <div id="ml_hr">-</div></td>
            <td> <div id="ml_distance">-</div></td>
            <td> <div id="ml_speed">-</div></td>
          </tr>
          <tr>
            <td>Jalabert</td>
            <td> <div id="lj_hr">-</div></td>
            <td> <div id="lj_distance">-</div></td>
            <td> <div id="lj_speed">-</div></td>
          </tr>
        </table>

    </body>
</html>
