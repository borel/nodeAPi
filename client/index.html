<html>
<head>

  <title>Smoozi NYC</title>

  <!-- Meta -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="Description" lang="en" content="ADD SITE DESCRIPTION">
  <meta name="author" content="ADD AUTHOR INFORMATION">
  <meta name="robots" content="index, follow">

  <!-- CSS -->

  <link rel="stylesheet" type="text/css" href="./css/flipclock.css">
  <link rel="stylesheet" type="text/css" href="./css/style.css" />

  <!-- JS -->
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmhelMVEXev83EyFPJhCJ1fYnQleKPfos&sensor=true"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="./js/marathon_value.js"></script>
  <script type="text/javascript" src="./js/chart.js"></script>
  <script type="text/javascript" src="./js/jquery.js"></script>
  <script type="text/javascript" src="./js/flipclock.min.js"></script>

</head>
<body>


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-57925881-11', 'auto');
  ga('send', 'pageview');

  </script>

  <script type="text/javascript">
  ////////////////////////////////////////////////////////////////////
  ////////////// GMAPS ///////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////
  var map = null;
  var countLJ = null;
  var countML = null;
  var clock = null

  // tab of user information
  var users = {};

  function mapInitialize() {
    map = new google.maps.Map(document.getElementById("map-canvas"), {
      zoom: 12,
      // nyc   center: new google.maps.LatLng(40.742494, -73.953867)
      center: new google.maps.LatLng(45.764043, 4.835659)
    });
    infowindow = new google.maps.InfoWindow({ content: 'Test' });
    google.maps.event.addListener(map, 'click', function() {
      infowindow.close(map);
    });

    nycMarathonInitialize();
  }


  function nycMarathonInitialize(){
    var nycMarathon = new google.maps.Polyline({
      path: nycMarathonCoordinates,
      geodesic: true,
      strokeColor: '#FF0000',
      strokeOpacity: 1.0,
      strokeWeight: 2
    });

    nycMarathon.setMap(map);
  }


  function updateMarker(name,lat,long){
    // Take the user
    var user = users[name];
    // si il n'esite pas on crÃ©ait le marker et son user
    if(!user){
      user = createUser(name);
      users[name] = user;
    }
    //On update le marker ( qu(il soit nouveau ou ancien))
    user.marker.setPosition(new google.maps.LatLng(lat, long));
  }

  function createUser(name){
    var user = new Object();

    //affect the name
    user.name = name;

    // crearte the marker
    var marker = new google.maps.Marker({ map:map });
    google.maps.event.addListener(marker, 'click', function() {
      infowindow.setContent(marker.getTitle());
      infowindow.open(map, marker);
    });

    // Img management
    if(name === 'lj'){
      //marker.setIcon('./img/LJ.png')
    }else{
      //marker.setIcon('./img/ML.png')
    }

    // affect set marker
    user.marker = marker;

    return user;
  }



  function updateIndicator(name,hr,speed,distance){
    if(name === 'lj'){
      // incrmeent the display token
      countLJ++;
      // Update graph
      window.tabHrLj.addData([hr], "");
      window.tabSpeedLj.addData([speed], "");
      updateChartData(window.tabDistLj,distance);
      // if there is already 10 value , we delete the first value
      if(countLJ > 10){
        window.tabHrLj.removeData();
        window.tabSpeedLj.removeData();
      }
      //Update graph
      window.tabHrLj.update();
      window.tabSpeedLj.update();
      //Update labels
      document.getElementById('hr_lj').textContent = hr + ' BPM';
      document.getElementById('speed_lj').textContent = speed + ' km/h';
      document.getElementById('distance_lj').textContent = distance + ' métres';
    }else{
      // incrmeent the display token
      countML++;
      // Update graph
      window.tabHrMl.addData([hr], "");
      window.tabSpeedMl.addData([speed], "");
      updateChartData(window.tabDistMl,distance);
      // if there is already 10 value , we delete the first value
      if(countML > 10){
        window.tabHrMl.removeData();
        window.tabSpeedMl.removeData();
      }
      //update graph
      window.tabSpeedMl.update();
      window.tabHrMl.update();
      //Update labels
      document.getElementById('hr_ml').textContent = hr + ' FC';
      document.getElementById('speed_ml').textContent = speed + ' km/h';
      document.getElementById('distance_ml').textContent = distance + ' métres';
    }


  }


  ////////////////////////////////////////////////////////////////////
  ////////////// /GMAPS ///////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////

  ////////////////////////////////////////////////////////////////////
  ////////////// /Graph ///////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////
  var data = {
    labels: [
    ],
    datasets: [
      {
          fillColor: "#000",
          strokeColor: "rgba(172, 12, 14, 0.9)",
          pointColor: "rgba(172, 12, 14, 0.9)",
          pointStrokeColor: "rgba(249, 12, 14, 0.9)",
          pointHighlightFill: "rgba(249, 12, 14, 0.9)",
          pointHighlightStroke: "rgba(249, 12, 14, 0.9)",
        data: []
      },
    ]
  };

  ////////////////////////////////////////////////////////////////////
  ////////////// /Graph ///////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////

  ////////////////////////////////////////////////////////////////////
  ////////////// table_data //////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////
  function addDataKm(nbk,user,time,tklk,speedlk,hrlk)
  {
    var newRow = document.createElement('tr');
  //  newRow.innerHTML = '  <th scope="row">'+nbk+'</th>  <td>'+time.h+'h'+time.m+'m'+time.s+'s</td>   <td>'+tklk.h+'h'+tklk.m+'m'+tklk.s+'s</td>  <td>'+speedlk+'</td>   <td>'+hrlk+'</td>';
    newRow.innerHTML = '  <th scope="row">'+nbk+'</th> <td>'+tklk.h+':'+tklk.m+':'+tklk.s+'</td>  <td>'+time.h+':'+time.m+':'+time.s+'</td>   ';
    if(user === 'lj'){
      document.getElementById('table_km_lj').appendChild(newRow);
    }else{
      document.getElementById('table_km_ml').appendChild(newRow);
    }
  }
  ////////////////////////////////////////////////////////////////////
  ////////////// /table_data//////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////

  ////////////////////////////////////////////////////////////////////
  ////////////// chart_data //////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////
  function updateChartData(chart,distance)
  {
    chart.removeData();
    chart.removeData();

    var percentToDo
    var percentDone

    if(distance > 500){
     percentToDo = Math.round(distance/42195*100);
     percentDone = 100 - percentToDo
   }else{
     percentToDo = 100;
     percentDone = 0;

   }

    chart.addData({
      value: percentToDo,
      color:"#ff0000",
      highlight: "#F7464A",
      label: "A faire"
    });

    chart.addData({
      value: percentDone,
      color: "#71fc07",
      highlight: "#0cf4c7",
      label: "Fait"
    });

    chart.update();

  }
  ////////////////////////////////////////////////////////////////////
  ////////////// /chart_data//////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////



  ////////////////////////////////////////////////////////////////////
  ////////////// Socket///////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////
  var socket = io.connect('/');

  socket.on('add_marker', function(data) {
    updateMarker(data.user,data.lat,data.long);
    updateIndicator(data.user,data.hr,data.speed,data.distance);
  })

  socket.on('add_data_table', function(data) {
    addDataKm(data.nbk,data.user,data.time,data.tklk,data.speedlk,data.hrlk);
  })

  socket.on('init_data_table_lj', function(data) {
    //init the tab
    var tableDataLj = document.getElementById('table_km_lj');
    while(tableDataLj.childNodes.length>2){tableDataLj.removeChild(tableDataLj.lastChild);}

    //push the data
    for (index = 1; index < data.length; ++index) {
       if(data[index] != null){
         addDataKm(index,'lj',data[index][0],data[index][1],data[index][2],data[index][3]);
        }
     }
  })

  socket.on('init_data_table_ml', function(data) {
    //init the tab
    var tableDataMl = document.getElementById('table_km_ml');
    while(tableDataMl.childNodes.length>2){tableDataMl.removeChild(tableDataMl.lastChild);}

    //push the data
    for (index = 1; index < data.length; ++index) {
      if(data[index] != null){
       addDataKm(index,'ml',data[index][0],data[index][1],data[index][2],data[index][3]);
     }
    }
  })

  socket.on('init_value', function(data) {
    updateChartData(window.tabDistMl,data.distanceML);
    updateChartData(window.tabDistLj,data.distanceLJ);
  })


  socket.on('init_clock', function(data) {
    clock.setTime(data);
    clock.start();
  })

  socket.on('stop_clock', function(data) {
    clock.stop();
  })

  socket.on('start_message', function(data) {
    document.getElementById('message').textContent = data.message;

  })

  socket.on('stop_message', function(data) {
    document.getElementById('message').textContent = "";
  })

  ////////////////////////////////////////////////////////////////////
  ////////////// Common ///////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////
  google.maps.event.addDomListener(window, 'load', mapInitialize);

  window.onload = function(){
    var ctx = document.getElementById("tab_hr_ml").getContext("2d");
    window.tabHrMl = new Chart(ctx).Line(data, {
      scaleShowGridLines : true,
      responsive : true,
      bezierCurve: true,
      scaleLineColor: "rgba(255, 255, 255, 1)",
      showScale: true,
      scaleOverride: true,
      scaleSteps: 7,
      scaleStepWidth: 20,
      scaleStartValue: 60,

    });

    var ctx = document.getElementById("tab_speed_ml").getContext("2d");
    window.tabSpeedMl = new Chart(ctx).Line(data, {
          scaleShowGridLines : true,
      responsive : true,
      bezierCurve: true,
      scaleLineColor: "rgba(255, 255, 255, 1)",
      showScale: true,
      scaleOverride: true,
      scaleSteps: 7,
      scaleStepWidth: 2,
      scaleStartValue: 4,

    });

    var ctx = document.getElementById("tab_dist_ml").getContext("2d");
    window.tabDistMl = new Chart(ctx).Doughnut(null, {
      responsive : true,
      animationSteps: 1,
      animateScale : false,
      });


    var ctx = document.getElementById("tab_hr_lj").getContext("2d");
    window.tabHrLj = new Chart(ctx).Line(data, {
      responsive : true,
      bezierCurve: true,
      scaleLineColor: "rgba(255, 255, 255, 1)",
      showScale: true,
      scaleOverride: true,
      scaleSteps: 7,
      scaleStepWidth: 20,
      scaleStartValue: 60,

    });

    var ctx = document.getElementById("tab_speed_lj").getContext("2d");
    window.tabSpeedLj = new Chart(ctx).Line(data, {
      responsive : true,
      bezierCurve: true,
      scaleLineColor: "rgba(255, 255, 255, 1)",
      showScale: true,
      scaleOverride: true,
      scaleSteps: 7,
      scaleStepWidth: 2,
      scaleStartValue: 4,
    });

    var ctx = document.getElementById("tab_dist_lj").getContext("2d");
    window.tabDistLj = new Chart(ctx).Doughnut(null, {
        responsive : true,
        animationSteps: 1,
        animateScale : false,

      });

    clock = $('.marathon-clock').FlipClock({
      autoStart : false
    });


  }

  ////////////////////////////////////////////////////////////////////
  ////////////// /Common///////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////
  </script>


  <div class="header">
    <div class="container">
      <h1 class="header-heading">Smoozi</h1>
    </div>
  </div>
  <div class="nav-bar">
    <div class="container">
      <ul class="nav">
          <h3 style='color:red'><div id='message'></div></h3>
      </ul>
    </div>
  </div>
  <div class="content">
    <div class="container">
      <div class="col1">
        <!-- Responsive images -->
        <div id="map-canvas"></div>
        <div id="clock-canvas"  class="marathon-clock"></div>

        <a class="twitter-timeline" href="https://twitter.com/GetSmoozi" data-widget-id="656399080990646272">Tweets de @GetSmoozi</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
        <!-- <h2> Jalabert </h2>

        <h2> Landreau </h3> -->

      </div>
      <div class="col2">
        <h3>Landreau</h3>
        <h6>Fréquence cardiaque</h6><h5><div id='hr_ml'></div></h5>
        <p><canvas id="tab_hr_ml"></p>
          <h6>Vitesse</h6><h5> <div id='speed_ml'></div></h5>
            <p><canvas id="tab_speed_ml"></p>
              <h6>Distance</h6> <h5><div id='distance_ml'></div></h5>
                <p><canvas id="tab_dist_ml"></p>
                    <h6>Résumé</h6>
                  <table class="table table-striped" id="table_km_ml">
                    <thead>
                      <tr>
                        <th>Km</th>
                        <th>Temps au kilométre</th>
                        <th>Temps total</th>

                        <!-- <th>Vitesse moyenne</th>
                        <th>FC moyenne</th> -->
                      </tr>
                    </thead>
                    <tbody>

                    </tbody>
                  </table>

      </div>
            <div class="col3">
              <h3>Jalabert</h3>
              <h6>Fréquence cardiaque</h6> <h5><div id='hr_lj'></div></h5></h5></h5>
              <p><canvas id="tab_hr_lj"></p>
                <h6>Vitesse ( en km/h)</h6> <h5><div id='speed_lj'></div></h5></h5>
                  <p><canvas id="tab_speed_lj"></p>
                    <h6>Distance</h6><h5><div id='distance_lj'></div></h5>
                        <p><canvas id="tab_dist_lj"></p>
                          <h6>Résumé</h6>
                          <table class="table table-striped" id='table_km_lj'>
                            <thead>
                              <tr>
                                <th>Km</th>
                                <th>Temps au kilométre</th>
                                <th>Temps total</th>
                                <!-- <th>Vitesse moyenne</th>
                                <th>FC moyenne</th> -->
                              </tr>
                            </thead>
                            <tbody>
                            </tbody>
                          </table>

                  </div>
                </div>
              </div>


              <div class="footer">
                <div class="container">
                  &copy; <a href="http://www.cityzensciences.fr/">Cityzen Sciences </a> - 2015 -
                </div>
              </div>
            </body>
            </html>
