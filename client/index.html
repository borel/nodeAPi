<html>
    <head>
        <title>Smoozi Tracker</title>
    </head>
    <body>

        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmhelMVEXev83EyFPJhCJ1fYnQleKPfos&sensor=true"></script>
        <script type="text/javascript" src="/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="./jquery.min.js"></script>
        <script type="text/javascript" src="./marathon.js"></script>

    	<script type="text/javascript">
            ////////////////////////////////////////////////////////////////////
            ////////////// GMAPS ///////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////
            var map = null;
            var users = {};

            function guid() {
              function s4() { return Math.floor((1 + Math.random()) * 0x10000)
                  .toString(16).substring(1);
              };

              return s4() + s4() + '-' + s4() + '-' + s4() + s4();
          }


            var userInfo = {
                id: guid(),
                name: 'Anonymous'
            }

            function mapInitialize() {
                map = new google.maps.Map(document.getElementById("map-canvas"), {
                    zoom: 12,
                    center: new google.maps.LatLng(40.742494, -73.953867)
                });
                infowindow = new google.maps.InfoWindow({ content: 'Test' });
                google.maps.event.addListener(map, 'click', function() {
                    infowindow.close(map);
                });

                nycMarathonInitialize();
            }


            function nycMarathonInitialize(){
                var nycMarathon = new google.maps.Polyline({
                path: nycMarathonCoordinates,
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 1.0,
                strokeWeight: 2
              });

                nycMarathon.setMap(map);
            }


            function updateMarker(name,lat,long){

              // Take the user
                    var userInformation = users[name];

                    // si il n'esite pas on cr√©ait le marker et son user
                      if(!userInformation){
                        // New object of user info
                        users[name] = userInfo;

                        // affect to userInformation for update
                        userInformation = users[name];

                        // crearte the marker
                        var marker = new google.maps.Marker({ map:map });
                         google.maps.event.addListener(marker, 'click', function() {
                                     infowindow.setContent(marker.getTitle());
                                     infowindow.open(map, marker);
                         });

                         // Img management
                         if(name === 'lj'){
                           marker.setIcon('./img/LJ.png')
                         }else{
                           marker.setIcon('./img/ML.png')
                         }

                         //affect the marker
                         userInformation.marker = marker;
                      }

                //On update le marker ( qu(il soit nouveau ou ancien))
                userInformation.marker.setPosition(new google.maps.LatLng(lat, long));

            }


            ////////////////////////////////////////////////////////////////////
            ////////////// /GMAPS ///////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////




            ////////////////////////////////////////////////////////////////////
            ////////////// Socket///////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////
            var socket = io.connect('/');

            socket.on('message', function(data) {
                updateMarker(data.user,data.lat,data.long);
            })
            ////////////////////////////////////////////////////////////////////
            ////////////// /Socket///////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////

            ////////////////////////////////////////////////////////////////////
            ////////////// Common ///////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////
            google.maps.event.addDomListener(window, 'load', mapInitialize);
            ////////////////////////////////////////////////////////////////////
            ////////////// /Common///////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////


    	</script>

        <style>
            #map-canvas  { height: 80%; width:80%}
            #user-number { font-size: 15px; font-weight: bold; font-color:black;}
        </style>

        <p> Welcome to NYC marathon tracker</p>
        <div id="map-canvas"></div>

    </body>
</html>
