<html>
    <head>
        <title>Smoozi Tracker</title>
        <link rel="stylesheet" type="text/css" href="./css/style.css" />
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmhelMVEXev83EyFPJhCJ1fYnQleKPfos&sensor=true"></script>
        <script type="text/javascript" src="/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="./js/marathon_value.js"></script>
        <script type="text/javascript" src="./js/chart.js"></script>



    </head>
    <body>


        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-57925881-11', 'auto');
          ga('send', 'pageview');

        </script>

      	<script type="text/javascript">
              ////////////////////////////////////////////////////////////////////
              ////////////// GMAPS ///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////
              var map = null;
              var users = {};

              function guid() {
                function s4() { return Math.floor((1 + Math.random()) * 0x10000)
                    .toString(16).substring(1);
                };

                return s4() + s4() + '-' + s4() + '-' + s4() + s4();
            }


              var userInfo = {
                  id: guid(),
                  name: 'Anonymous'
              }

              function mapInitialize() {
                  map = new google.maps.Map(document.getElementById("map-canvas"), {
                      zoom: 12,
                      // nyc   center: new google.maps.LatLng(40.742494, -73.953867)
                      center: new google.maps.LatLng(45.764043, 4.835659)
                  });
                  infowindow = new google.maps.InfoWindow({ content: 'Test' });
                  google.maps.event.addListener(map, 'click', function() {
                      infowindow.close(map);
                  });

                  nycMarathonInitialize();
              }


              function nycMarathonInitialize(){
                  var nycMarathon = new google.maps.Polyline({
                  path: nycMarathonCoordinates,
                  geodesic: true,
                  strokeColor: '#FF0000',
                  strokeOpacity: 1.0,
                  strokeWeight: 2
                });

                  nycMarathon.setMap(map);
              }


              function updateMarker(name,lat,long){

                // Take the user
                      var userInformation = users[name];

                      // si il n'esite pas on cr√©ait le marker et son user
                        if(!userInformation){
                          // New object of user info
                          users[name] = userInfo;

                          // affect to userInformation for update
                          userInformation = users[name];

                          // crearte the marker
                          var marker = new google.maps.Marker({ map:map });
                           google.maps.event.addListener(marker, 'click', function() {
                                       infowindow.setContent(marker.getTitle());
                                       infowindow.open(map, marker);
                           });

                           // Img management
                           if(name === 'lj'){
                             marker.setIcon('./img/LJ.png')
                           }else{
                             marker.setIcon('./img/ML.png')
                           }

                           //affect the marker
                           userInformation.marker = marker;
                        }

                  //On update le marker ( qu(il soit nouveau ou ancien))
                  userInformation.marker.setPosition(new google.maps.LatLng(lat, long));

              }

              function updateIndicator(name,hr,speed,distance){
                if(name === 'lj'){
                  document.getElementById("lj_hr").textContent = hr;
                  document.getElementById("lj_speed").textContent = speed;
                  document.getElementById("lj_distance").textContent = distance;

                }else{
                  document.getElementById("ml_hr").textContent = hr;
                  document.getElementById("ml_speed").textContent = speed;
                  document.getElementById("ml_distance").textContent = distance;
                }
              }


              ////////////////////////////////////////////////////////////////////
              ////////////// /GMAPS ///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////

              ////////////////////////////////////////////////////////////////////
              ////////////// /Graph ///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////
              var tkLandreau = [];
              var tkJalabert = [];

              var data = {
                  labels: [
                          ],
                  datasets: [
                      {
                          label: "Jalabert",
                          fillColor: "rgba(220,220,220,0.5)",
                          strokeColor: "rgba(220,220,220,0.8)",
                          highlightFill: "rgba(220,220,220,0.75)",
                          highlightStroke: "rgba(220,220,220,1)",
                          data: tkJalabert
                      },
                      {
                          label: "Landreau",
                          fillColor: "rgba(151,187,205,0.5)",
                          strokeColor: "rgba(151,187,205,0.8)",
                          highlightFill: "rgba(151,187,205,0.75)",
                          highlightStroke: "rgba(151,187,205,1)",
                          data: tkLandreau
                      }
                  ]
              };

              function updateGraph(name,tk){
                if(name === 'lj'){
                  tkJalabert.push(tk);
                }else{
                  tkLandreau.push(tk);
                }
                window.myBar.addData([tk, tk], "1k");
                window.myBar.update();
              }

              ////////////////////////////////////////////////////////////////////
              ////////////// /Graph ///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////


              ////////////////////////////////////////////////////////////////////
              ////////////// Socket///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////
              var socket = io.connect('/');

              socket.on('add_marker', function(data) {
                  updateMarker(data.user,data.lat,data.long);
                  updateIndicator(data.user,data.hr,data.speed,data.distance);
              })

              socket.on('add_pk', function(data) {
                  updateGraph(data.user,data.tk);
              })
              ////////////////////////////////////////////////////////////////////
              ////////////// /Socket///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////

              ////////////////////////////////////////////////////////////////////
              ////////////// Common ///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////
              google.maps.event.addDomListener(window, 'load', mapInitialize);

              window.onload = function(){
            		var ctx = document.getElementById("bar_tab").getContext("2d");
            		window.myBar = new Chart(ctx).Line(data, {
            			responsive : true,
                   bezierCurve: true
            		});
            	}

              ////////////////////////////////////////////////////////////////////
              ////////////// /Common///////////////////////////////////////////////
              ////////////////////////////////////////////////////////////////////


      	</script>

		<div id="top">
			<div align="center"> <h2> Welcome to NYC marathon tracker </h2></div>
		</div>

    <div id="left">
        <table>
          <tr>Landreau</tr>
          <tr> <div id="ml_hr">-</div></tr>
          <tr> <div id="ml_distance">-</div></tr>
          <tr> <div id="ml_speed">-</div></tr>
        </table>
    </div>

    <div id="middle">
        <div id="map-canvas"></div>
    </div>

    <div id="right">
        <table>
            <tr>Jalabert</tr>
            <tr> <div id="lj_hr">-</div></tr>
            <tr> <div id="lj_distance">-</div></tr>
            <tr> <div id="lj_speed">-</div></tr>
        </table>
    </div>
    <div id="middle">
      <canvas id="bar_tab" height="100" width="200"></canvas>
    </div>
    </body>
</html>
